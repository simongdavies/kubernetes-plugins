trigger:
  branches:
    include:
      - refs/heads/main
  tags:
    include:
    - v*
pr: none

pool:
  vmImage: 'Ubuntu 18.04'

variables:
  GOVERSION: "1.14.6"
  tag: $[replace(variables['Build.SourceBranch'],'refs/tags/','')]

steps:
#  - template: build-and-test.yml
  
  - script: make xbuild-all 
    workingDirectory: '$(System.DefaultWorkingDirectory)'
    displayName: 'Build Release'

  - script: | 
      export AZURE_STORAGE_CONNECTION_STRING=$(AZURE_STORAGE_CONNECTION_STRING)
      make publish
    workingDirectory: '$(System.DefaultWorkingDirectory)'
    displayName: 'Publish'

  - task: GitHubRelease@0
    condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/'))
    inputs:
      gitHubConnection: $(GITHUB_CONNECTIONNAME)
      repositoryName: '$(Build.Repository.Name)' 
      action: 'create' 
      tagSource: 'auto'
      assets: '$(System.DefaultWorkingDirectory)/bin/plugins/kubernetes/$(tag)/**'
      addChangeLog: true 
      compareWith: 'lastFullRelease'